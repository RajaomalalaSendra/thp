<!DOCTYPE html>
<html class="loading" lang="fr">
  <head>
  <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="../../style/bootstrap.css">
    <title>The hacking project offline</title>
  </head>
  <body class="vertical-layout vertical-menu 2-columns  menu-expanded fixed-navbar" data-open="click" data-menu="vertical-menu" data-color="bg-gradient-x-primary-blue" data-col="2-columns">
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <h1 class="navbar-brand">THE HACKING PROJECT</h1>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor01">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="../../">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../../features">Features</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../../about">About</a>
            </li>
          </ul>
          <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="text" placeholder="Search">
            <button class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
          </form>
        </div>
      </nav>

<div class="container">
    <a type="button" class="btn btn-dark " href="../../semaine_1/">Semaine 1</a>
    <a type="button" class="btn btn-dark" href="../../semaine_2/">Semaine 2</a>
    <a type="button" class="btn btn-dark" href="../../semaine_3/">Semaine 3</a>
    <a type="button" class="btn btn-dark" href="../../semaine_4/">Semaine 4</a>
    <a type="button" class="btn btn-dark" href="../../semaine_5/">Semaine 5</a>
    <a type="button" class="btn btn-dark btn-lg" href="../../semaine_6/">Semaine 6</a>  
</div>

<div class="app-content content">
  <div class="content-wrapper">
    <div class="content-wrapper-before"></div>
    <div class="content-header row"></div>
    
      <div class="container">
    <div class="card">
  <div class="card-header">
    <h4 class="text-center"> Programme jour par jour</h4>
  </div>
  <div class="card-body">
    <div class="text-center">
    <a href="../../semaine_6">
      <button class="btn btn-secondary btn-outline-dark btn mr-4">
        <i class="fa fa-terminal"></i>&nbsp;&nbsp;&nbsp;Lun
      </button>
</a>    <a href="../../semaine_6/jour_2">
      <button class="btn btn-secondary btn-outline-dark btn-lg mr-4">
        <i class="fa fa-code"></i>&nbsp;&nbsp;&nbsp;Mar
      </button>
</a>    <a href="../../semaine_6/jour_3">
      <button class="btn btn-secondary btn-outline-dark btn mr-4">
        <i class="fa fa-desktop"></i>&nbsp;&nbsp;&nbsp;Mer
      </button>
</a>    <a href="../../semaine_6/jour_4">
      <button class="btn btn-secondary btn-outline-dark btn mr-4">
      <i class="fa fa-folder-open"></i>&nbsp;&nbsp;&nbsp;Jeu
      </button>
</a>    <a href="../../semaine_6/jour_5">
      <button class="btn btn-secondary btn-outline-dark btn mr-4">
      <i class="fa fa-bullhorn"></i>&nbsp;&nbsp;&nbsp;Ven
      </button>
</a>    </div>
  </div>
</div>


<div class="app-content content">
  <div class="content-wrapper">
    <div class="content-wrapper-before"></div>
    <div class="content-header row"></div>
    
      
<div class="content-body">
      <h2 class="text-center">Devise</h2>
      <h4 class="text-center">Rails avancé</h4>
  <div class="row">
     <div class="col-xl-3 col-lg-6 col-md-12">
  <div class="card">
    <div class="card-content">
      <div class="card-body">
        <div class="media d-flex">
          <div class="align-self-top">
              <i class="ft-calendar icon-opacity info font-large-4"></i>
          </div>
          <div class="media-body text-right align-self-bottom mt-3">
              <span class="d-block mb-1 font-medium-1"></span>
              <h3 class="info mb-0">
                 Jour 25 / 55</h3>
          </div>
        </div>
        <div class="progress progress-sm mt-1 mb-0 box-shadow-2">
            <div class="progress-bar bg-gradient-x-info" role="progressbar" style="width: 45%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="120">
            </div>
        </div>
      </div>
    </div>
  </div>
 </div>


    <div class="col-xl-3 col-lg-6 col-md-12">
  <div class="card">
    <div class="card-content">
      <div class="card-body">
        <div class="media d-flex">
          <div class="align-self-top">
            <i class="ft-heart icon-opacity danger font-large-4"></i>
          </div>
          <div class="media-body text-right align-self-bottom mt-3">
            <span class="d-block mb-1 font-medium-1">Jokers restant</span>
            <h3 class="danger mb-0">
                3
            </h3>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

    <div class="col-xl-3 col-lg-6 col-md-12">
    <div class="card">
        <div class="card-content">
            <div class="card-body">
                <div class="media d-flex">
                    <div class="align-self-top">
                        <a href="/dashboard/assignments?locale=fr">
                           <i class="ft-fast-forward icon-opacity warning font-large-4"></i>
</a>                    </div>
                    <div class="media-body text-right align-self-bottom mt-3">
                        <span class="d-block mb-1 font-medium-1">Missions</span>
                            <div class="badge border-danger danger badge-border">Pas inscrit</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

  </div>
  <div class="row">
        <div class="container">
    <div class="col-xl-12 col-lg-12 col-md-12">
    <div class="card">
        <div class="card-header">
        <h1 >Rails avancé
                <i class="fa fa-beer text-warning"></i>
        </h1>
        
        </div>
        <div class="card-content">
        <div class="card-body">
            <div class="card-text">
            <h2 class="text-center">Devise</h2>
            <div class="cd-horizontal-timeline loaded">
                <div class="timeline">
                <div class="events-wrapper">
                    <div class="events" style="width: 1800px;">
                    <ol>
                                <li>
                                    <a style="left:120px;" href="/dashboard/weeks/6/days/1?locale=fr">
                                        Lun
                                            <i class="fa fa-rocket text-danger" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Projet à rendre ce jour-là"></i>

</a>                                </li>
                            <li>
                                <a class="selected" style="left:240px;" data-toggle="tooltip" data-placement="top" title="Devise" href="/dashboard/weeks/6/days/2?locale=fr">
                                    Mar
                                        <i class="fa fa-pencil text-success" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Corrections cette journée là" ></i>


</a>                                </li>
                                <li>
                                <a href="#" style="left: 360px;">
                                    Mer
                                    <i class="fa fa-lock fa-margin" aria-hidden="true"></i>
                                        <i class="fa fa-rocket text-danger" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Projet à rendre ce jour-là"></i>

                                </a>
                                </li>
                                <li>
                                <a href="#" style="left: 480px;">
                                    Jeu
                                    <i class="fa fa-lock fa-margin" aria-hidden="true"></i>
                                        <i class="fa fa-pencil text-success" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Corrections cette journée là" ></i>


                                </a>
                                </li>
                                <li>
                                <a href="#" style="left: 600px;">
                                    Ven
                                    <i class="fa fa-lock fa-margin" aria-hidden="true"></i>
                                        <i class="fa fa-beer text-warning" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Rendez-vous pour boire un coup"></i>

                                </a>
                                </li>
                    </ol>
                </div>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>
    </div>
<div>
  </div>

  <!-- Les fameuses corrections qui n'arrivnet que les jours concernés -->


    <div class="container">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header" style="border-top: 3px solid #5E66E5 " >
          <h1>Cours : Devise</h1>
          <a class="heading-elements-toggle">
          <i class="la la-ellipsis-v font-medium-3"></i>
          </a>
          <div class="heading-elements">
            <ul class="list-inline mb-0">
              <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
              <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
            </ul>
          </div> 
      </div>
      <div class="card-content collapse show">
        <div class="card-body">
          <div class="tab-pane active" id="home1" role="tabpanel">
          <h2>1. Introduction</h2>
<p>La semaine dernière tu as vu comment faire des logins à la main. C'est plutôt long et fastidieux. Et nous n'avons pas abordé la notion d'email de récupération de mot de passe (qui est assez similaire, avec un système de token et de hash). Aujourd'hui, tu vas voir une gem indispensable quand on fait du Rails : la gem <a href="https://github.com/plataformatec/devise" target="_blank">Devise</a>, qui permet de gérer toute l'authentification pour toi.</p>

<p>Devise va gérer pour toi :</p>

<ul>
  <li>La notion d'inscription, avec mot de passe et email</li>
  <li>La notion de login, logout, session, current user</li>
  <li>La notion de récupération de mot de passe par email</li>
  <li>La notion de confirmation de compte par email</li>
  <li>La notion de comptage de login</li>
  <li>La notion de logout après un certain temps d'inactivité</li>
  <li>La notion de blocage de compte après un certain nombre de tentative de login</li>
</ul>

<p>Bref, une gem très puissante qui t'aidera à bien gérer tes futures applications. Dans cette ressource, nous allons t'aider à la dompter.</p>

<h2>2. Historique</h2>
<p>Devise a été créée <a href="http://blog.plataformatec.com.br/2009/10/devise-flexible-authentication-solution-for-rails/" target="_blank">fin 2009</a> par plataformatec, un cabinet de conseil spécialisé en Rails.</p>

<h2>3. La ressource</h2>

<h3>3.1. Les fonctionnalités de Devise</h3>
<p>Voici les différentes fonctionnalités de Devise :</p>

<ul>
  <li><b>Database Authenticatable</b> : possibilité de stocker les mots de passe dans leur version hashée pour valider l'authenticité d'un utilisateur pendant sa connexion</li>
  <li><b>Omniauthable</b> : possibilité de gestion de OmniAuth</li>
  <li><b>Confirmable</b> : possibilité de forcer la confirmation par email du compte</li>
  <li><b>Recoverable</b> : possibilité de réinitialiser le mot de passe et d'envoyer des instructions de mot de passe par email</li>
  <li><b>Registerable</b> : possibilité de se connecter via un un formulaire. Aussi, possibilité d'éditer et de supprimer son compte</li>
  <li><b>Rememberable</b> : possibilité d'utiliser le fameux cookie <a href="https://www.youtube.com/watch?v=fKKNPLowteY" target="_blank">remember me</a></li>
  <li><b>Trackable</b> : possibilité de tracker le nombre de login, leurs timestamps, et les adresses IP</li>
  <li><b>Timeoutable</b> : possibilité d'expirer des sessions après un certain temps d'inactivité</li>
  <li><b>Validatable</b> : possibilité de donner des validations pour les emails et mots de passe (taille, regex, etc)</li>
  <li><b>Lockable</b> : possibilité de verrouiller un compte après trop de tentatives de connexion</li>
</ul>

<p>Nous allons voir dans cette ressource les plus importantes : Database Authenticatable, Registerable, Recoverable, Rememberable, Validatable.</p>

<h3>3.2. Installation</h3>
<h4>3.2.1. Installation</h4>
<p>Pour installer Devise, il faut d'abord commencer par mettre la gem dans le Gemfile, puis de faire bundle install.</p>

<p>Ensuite, on va devoir installer Devise avec la commande suivante :</p>

<pre><code class="language-ruby">$ rails generate devise:install</code></pre>

<p>Ce qui a pour effet de créer deux fichiers :</p>

<ul>
  <li><code>config/initializers/devise.rb</code> : le fichier de configuration de Devise. On s'en servira par exemple pour paramétrer le service que l'on va utiliser pour les envois d'emails</li>
  <li><code>config/locales/devise.en.yml</code> : un fichier contenant les messages d'erreur de Devise. Tu pourras utiliser <a href="https://github.com/plataformatec/devise/wiki/I18n#french-devisefryml" target="_blank">ses version françaises</a> quand tu seras plus à l'aise</li>
</ul>

<p>Puis après avoir créé les fichiers, la console devrait te dire 4 choses. Le plus important étant le premier : il faut que tu dises à ton application "hey fais quelque chose pour les emails en local stp". En gros, pour le moment ton application plante quand un email est envoyé, et notre ami Devise va utiliser les emails (notamment pour réinitialiser son mot de passe). Demain nous verrons comment faire les branchements des emails sur Heroku, mais pour le moment on va le brancher en développement pour que cela marche. Donc dans le fichier <code>config/environments/development.rb</code>, mets-donc la ligne suivante :</p>

<pre><code class="language-ruby">config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }</code></pre>

<p>Quand tu cliqueras sur "réinitialiser mon mot de passe" pour la tester, l'application ne plantera pas. Maintenant tout est réglé pour utiliser Devise. Super !</p>

<h4>3.2.2. Génération du model</h4>

<p>Devise utilise comme Rails un générateur qui va nous mâcher le travail. Pour dire à Devise que tel model va être en mode Devise (avec la notion de session, login, etc), on fera <code>rails g devise model</code>. La majorité du temps cela concerne les utilisateurs (tout site), avec quelques exceptions quand cela concerne plutôt les admins (un blog sans gestion d'utilisateur). Ainsi, pour une app normale dans laquelle nous voulons avoir Devise branchée sur les utilisateurs, tu feras :</p>

<pre><code>$ rails g devise user</code></pre>

<p>Cela va créer et modifier quelques fichiers, mais trois nous intéressent beaucoup : une fichier de migration, un fichier de model, et une modification des routes.</p>

<h5>3.2.2.1. Le fichier de migration</h5>
<p>Voici le fichier de migration que Devise va te générer :</p>

<pre><code class="language-ruby"># frozen_string_literal: true

class DeviseCreateUsers < ActiveRecord::Migration[5.2]
  def change
    create_table :users do |t|
      ## Database authenticatable
      t.string :email,              null: false, default: ""
      t.string :encrypted_password, null: false, default: ""

      ## Recoverable
      t.string   :reset_password_token
      t.datetime :reset_password_sent_at

      ## Rememberable
      t.datetime :remember_created_at

      ## Trackable
      # t.integer  :sign_in_count, default: 0, null: false
      # t.datetime :current_sign_in_at
      # t.datetime :last_sign_in_at
      # t.inet     :current_sign_in_ip
      # t.inet     :last_sign_in_ip

      ## Confirmable
      # t.string   :confirmation_token
      # t.datetime :confirmed_at
      # t.datetime :confirmation_sent_at
      # t.string   :unconfirmed_email # Only if using reconfirmable

      ## Lockable
      # t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts
      # t.string   :unlock_token # Only if unlock strategy is :email or :both
      # t.datetime :locked_at


      t.timestamps null: false
    end

    add_index :users, :email,                unique: true
    add_index :users, :reset_password_token, unique: true
    # add_index :users, :confirmation_token,   unique: true
    # add_index :users, :unlock_token,         unique: true
  end
end</code></pre>

<p>C'est une migration pour créer une table users, puis lui ajouter les attributs qui vont permettre à Devise de paramétrer. que Devise va gérer. De base, Devise ne gère que Database Authenticatable, Registerable, Recoverable, Rememberable, et Validatable. Les autres attributs sont en gris et tu n'as qu'à décommenter les lignes qui t'intéressent. Comme nous ne nous intéressons qu'aux 5 étapes mentionnées ci-haut, cette migration est parfaite pour nous.</p>


<div class="card box-shadow-0 border-info">
  <div class="card-content collapse show">
    <div class="card-body">
      <h4 class="card-title">🤓 QUESTION RÉCURRENTE</h4>
      <p><b>Mais dis-donc Jamy, comment on fait si l'on a déjà créé le model User ?</b><br>
        Devise est plutôt intelligente, puisque elle va changer ta migration de <code>create_table</code> à <code>change_table</code>. Il y aura deux détails à gérer :</p>
        <ul>
          <li>Si jamais tu as déjà dans ta table users une colonne que Devise utilise (email, encrypted_password, etc), la migration plantera puisque Devise les ajoute aussi (c'est comme si tu avais deux colonnes email, et ça ne marche pas)</li>
          <li>En l'état il n'est pas possible de rollback ta migration. Il te faudra ajouter à la main la partie <code>self.down</code>, avec des : <code>remove_column</code> ou des <code>remove_index</code> pour que tout aille bien</li>
        </ul>
    </div>
  </div>
</div>


<h5>3.2.2.2. Le fichier de model</h5>
<p>Voici ton fichier de model :</p>

<pre><code class="language-ruby">class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable, :trackable and :omniauthable
  devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :validatable
end</code></pre>

<p>Ces quelques lignes vont juste dire à ton model, "hey, c'est possible de faire de database_authenticatable, registerable, recoverable, rememberable, et validatable". Si tu veux faire l'un des autres, il te faudra le mettre dans la liste des options non commentées.</p>


<h5>3.2.2.3. Le fichier des routes</h5>
<p>Normalement les routes devraient t'afficher <code>devise_for :users</code>. Inspectons ceci avec <code>rails routes</code> :</p>

<pre><code class="language-shell">                   Prefix Verb   URI Pattern                                                                              Controller#Action
         new_user_session GET    /users/sign_in(.:format)                                                                 devise/sessions#new
             user_session POST   /users/sign_in(.:format)                                                                 devise/sessions#create
     destroy_user_session DELETE /users/sign_out(.:format)                                                                devise/sessions#destroy
        new_user_password GET    /users/password/new(.:format)                                                            devise/passwords#new
       edit_user_password GET    /users/password/edit(.:format)                                                           devise/passwords#edit
            user_password PATCH  /users/password(.:format)                                                                devise/passwords#update
                          PUT    /users/password(.:format)                                                                devise/passwords#update
                          POST   /users/password(.:format)                                                                devise/passwords#create
 cancel_user_registration GET    /users/cancel(.:format)                                                                  devise/registrations#cancel
    new_user_registration GET    /users/sign_up(.:format)                                                                 devise/registrations#new
   edit_user_registration GET    /users/edit(.:format)                                                                    devise/registrations#edit
        user_registration PATCH  /users(.:format)                                                                         devise/registrations#update
                          PUT    /users(.:format)                                                                         devise/registrations#update
                          DELETE /users(.:format)                                                                         devise/registrations#destroy
                          POST   /users(.:format)                                                                         devise/registrations#create</code></pre>


<p>On va les décrypter une à une :</p>

<ul>
  <li><code>devise/sessions#new</code> : la vue pour se connecter</li>
  <li><code>devise/sessions#create</code> : le POST pour se connecter</li>
  <li><code>devise/sessions#destroy</code> : le bouton logout</li>
  <li><code>devise/passwords#new</code> : l'écran "mot de passe oublié ?" où tu rentres ton adresse email pour recevoir un email de réinitialisation de mot de passe</li>
  <li><code>devise/passwords#create</code> : le POST pour réinitialiser le mot de passe</li>
  <li><code>devise/passwords#edit</code> : la vue où tu rentres ton nouveau mot de passe (tu y accèdes en cliquant dans le lien "réinitialiser le mot de passe" dans ton email de réiniialisation de mot de passe)</li>
  <li><code>devise/passwords#update</code> : le PATCH/PUT pour changer de mot de passe</li>
  <li><code>devise/registrations#cancel</code> (rarement utilisée) : remet à zéro la session actuelle</li>
  <li><code>devise/registrations#new</code> : inscription au site</li>
  <li><code>devise/registrations#create</code> : le POST pour s'inscrire sur le site</li>
  <li><code>devise/registrations#edit</code> : écran pour modifier son email et son mot de passe</li>
  <li><code>devise/registrations#update</code> : le PATCH/PUT pour modifier son email et mot de passe</li>
  <li><code>devise/registrations#destroy</code> : destruction de son compte</li>
</ul>

<p>Comme tu peux le voir, Devise gère pas mal de routes pour nous. L'autre bonne nouvelle est que les controllers sont tous faits. Si l'on génère les vues, tout est branché pour fonctionner correctement en local.</p>

<h4>3.2.3. Génération des views</h4>
<p>Avec Devise, il est facile de générer les views que la gem va gérer, il suffit de rentrer la ligne suivante :</p>

<pre><code class="language-shell">$ rails generate devise:views users</code></pre>

<p>Ainsi, voici une liste de fichiers qui vont être créés :</p>

<ul>
  <li><code>app/views/devise/shared/_links.html.erb</code> : une petite partial qui donne les différents liens que tu as besoin en fonction de la page (exemple : le lien "mot de passe oublié" sur l'écran de connexion)</li>
  <li><code>app/views/devise/confirmations/new.html.erb</code> : l'écran de confirmation (pas besoin pour le moment)</li>
  <li><code>app/views/devise/passwords/edit.html.erb</code> : la vue où tu rentres ton nouveau mot de passe (tu y accèdes en cliquant dans le lien "réinitialiser le mot de passe" dans ton email de réinitialisation de mot de passe)</li>
  <li><code>app/views/devise/passwords/new.html.erb</code> : l'écran "mot de passe oublié ?" où tu rentres ton adresse email pour recevoir un email de réinitialisation de mot de passe</li>
  <li><code>app/views/devise/registrations/edit.html.erb</code> : l"écran pour modifier son email et son mot de passe</li>
  <li><code>app/views/devise/registrations/new.html.erb</code> : inscription au site</li>
  <li><code>app/views/devise/sessions/new.html.erb</code> : connexion au site</li>
  <li><code>app/views/devise/unlocks/new.html.erb</code> : écran pour déverrouiller son compte (pas besoin pour le moment)</li>
  <li><code>app/views/devise/mailer/confirmation_instructions.html.erb</code> : email pour confirmer son compte (pas besoin pour le moment)</li>
  <li><code>app/views/devise/mailer/email_changed.html.erb</code> : email pour annoncer un changement d'email (so meta)</li>
  <li><code>app/views/devise/mailer/password_change.html.erb</code> : email pour annoncer que ton mot de passe a été changé</li>
  <li><code>app/views/devise/mailer/reset_password_instructions.html.erb</code> : email pour donner le lien pour changer de mot de passe</li>
  <li><code>app/views/devise/mailer/unlock_instructions.html.erb</code> : email pour débloquer ton compte (pas besoin pour le moment)</li>
</ul>

<p>Dans un chapitre suivant nous verrons comment donner un peu d'énergie à ces vues grâce à Bootstrap, mais pour le moment sache que les views que tu auras à gérer sont celles là. Maintenant que tout est bien paramétré sur le site, on va un peu jouer avec.</p>


<h3>3.3. Découverte de Devise</h3>
<p>⚠ Dans cette partie <code>3.3.</code>, nous allons faire un petit pas à pas pour que tu puisses voir les éléments importants de Devise. Prêt ? En avant, commence par créer une app bidon rails et fais les installations vues ci-haut.</p>

<p>Lance le serveur, va sur <code>/users/sign_up</code>. Tu devrais voir un écran d'inscription avec email et mot de passe rudimentaire, mais fonctionnel.</p>

<img src="https://i.imgur.com/RJS4vNO.png" class="img-fluid">

<p>Avant de t'inscrire, clique sur "login". Idem, tu devrais avoir un écran pour te connecter, avec en plus le lien pour t'inscrire, et le lien du mot de passe oublié. Clique sur ce dernier, qui devrait te demander une adresse.</p>

<p>Super, maintenant on va un peu jouer avec l'application. Fais <code>$ rails g controller home index secret</code>, ce qui devrait générer un controller home et une méthode index. Fais en sorte que <code>home#index</code> soit la root de ton application, puis va sur <code>app/views/home/index.html.erb</code> pour y mettre les lignes suivantes :</p>

<pre><code class="language-html">&lt;ul>
  &lt;% if user_signed_in? %>
    &lt;li>
      &lt;%= link_to "Sign out", destroy_user_session_path, method: :delete %>
    &lt;/li>
    &lt;li>
      Voici ton email : &lt;%= current_user.email %>
    &lt;/li>
    &lt;li>
      &lt;%= link_to "Secret page", home_secret_path %>
    &lt;/li>
    &lt;li>
      &lt;%= link_to "Edit email / password", edit_user_registration_path %>
    &lt;/li>
  &lt;% else %>
    &lt;li>    
      &lt;%= link_to "Sign in", new_user_session_path %>
    &lt;/li>
    &lt;li>
      &lt;%= link_to "Sign up", new_user_registration_path %>
    &lt;/li>
  &lt;% end %>
&lt;/ul></code></pre>

<p>Va sur la page d'accueil, essaie de t'inscrire, te déconnecter, te reconnecter, modifier ton email / mot de passe, mettre ton mot de passe oublié. Voilà la force de Devise : l'application gère toutes les notions de login / logout pour toi. Grâce à des petits <code>if</code> bien placés dans tes views, les helper comme <code>user_signed_in?</code> ou <code>current_user</code> sont très puissants.</p>

<div class="card box-shadow-0 border-info">
  <div class="card-content collapse show">
    <div class="card-body">
      <h4 class="card-title">🚀 ALERTE BONNE ASTUCE</h4>
      <p>Si tu mets un email valide dans l'écran "mot de passe oublié", et si tu as bien mis la ligne <code>config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }</code>, l'application ne devrait pas t'envoyer d'erreur. Mais si tu n'as pas letter_opener de branché, elle te redirige juste vers l'écran de login. Que fait-elle alors 🤔 Si tu vas dans ta console de serveur, quelques lignes devraient t'intéresser :</p>
      <pre><code class="language-shell">Devise::Mailer#reset_password_instructions: processed outbound mail in 7.2ms
Sent mail to fef@fef.fef (1.2ms)
Date: Tue, 05 Feb 2019 18:06:18 +0100
From: please-change-me-at-config-initializers-devise@example.com
Reply-To: please-change-me-at-config-initializers-devise@example.com
To: fef@fef.fef
Message-ID: <5c59c28a83b46_545d2add4ce62f5462976@felix.mail>
Subject: Reset password instructions
Mime-Version: 1.0
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;p>Hello fef@fef.fef!&lt;/p>

&lt;p>Someone has requested a link to change your password. You can do this through the link below.&lt;/p>

&lt;p>&lt;a href="http://localhost:3000/users/password/edit?reset_password_token=5nsneTHVGFWypsNVHuc4">Change my password&lt;/a>&lt;/p>

&lt;p>If you didn't request this, please ignore this email.&lt;/p>
&lt;p>Your password won't change until you access the link above and create a new one.&lt;/p>

Redirected to http://localhost:3000/users/sign_in
Completed 302 Found in 29ms (ActiveRecord: 10.8ms)</code></pre>
    <p>En gros ton application envoie un email comme convenu, mais comme rien n'est paramétré pour le local, les emails sont justes envoyés via le serveur. Ce qui nous intéresse dans cet email, c'est l'url pour réinitialiser son mot de passe, celle qui fait <code>http://localhost:3000/users/password/edit?reset_password_token=ton_token</code>. Copie-colle cette url (à partir de TA console bien entendu), puis va sur le lien. Tu devrais avoir un lien qui te propose de changer ton mot de passe. Trop cool !</p>
    </div>
  </div>
</div>

<p>Va sur la page <code>/users/edit</code> en étant connecté : top. Déconnecté-toi et ressaie d'y aller : Devise demande de te connecter pour aller. Sécurité AU TOP. Maintenant va sur la page <code>/home/secret</code> en étant connecté : top. Puis déconnecte-toi et va dessus en étant déconnecté : tu peux y accéder. Nous allons voir comment ne donner l'accès à cette page que pour les utilisateurs connectés. Gràce à la méthode <a href="https://github.com/plataformatec/devise#controller-filters-and-helpers" target="_blank">authenticate_user!</a>, il est aisé de restreindre une page pour les utilisateurs connectés. Va dans le <code>home_controller</code>, puis ajoute en ligne 2 la ligne suivante :</p>

<pre><code class="language-ruby">before_action :authenticate_user!, only: [:secret]</code></pre>

<p>Maintenant tente d'aller sur <code>/home/index</code> en étant déconnecté : super, Devise t'a redirigé vers l'écran de login. Petit bonus : si tu te connectes à partir de cet écran, Devise va savoir où tu voulais aller et va t'envoyer comme convenu sur <code>/home/index</code>. Pas mal pour une gem.</p>


<p>Comme tu as pu le voir dans ce cas pratique, Devise est une gem très puissante qui permet de gérer toute ton authentification sans aucun soucis. C'est un indispensable.</p>


<h3>3.4. Les views de Devise</h3>
<p>Devise vient avec des views qui sont pour le moins minimalistes. Avec Bootstrap, y'a moyen de transformer ce blob de formulaire en quelque chose de convenable. Voici donc une page sans CSS d'inscription au site :</p>

<pre><code class="language-html">&lt;div class="container">
  &lt;div class="row">
    &lt;div class="col-md-6 offset-md-3">
      &lt;br>&lt;br>&lt;br>
      &lt;%= form_for resource, as: resource_name, url: registration_path(resource_name), html: { class: "form-signin mt-3" } do |f| %>
        &lt;h1 class="h3 mb-3 font-weight-normal text-center">Sign up&lt;/h1>
        &lt;%= devise_error_messages! %>
        &lt;div class="form-group">
          &lt;%= f.label :email, "Email" %>&lt;br />
          &lt;%= f.email_field :email, autofocus: true, autocomplete: "email", class: "form-control" %>
        &lt;/div>
        &lt;div class="form-group">
          &lt;%= f.label :password %>
          &lt;% if @minimum_password_length %>
          &lt;em>(&lt;%= @minimum_password_length %> characters minimum)&lt;/em>
          &lt;% end %>&lt;br />
          &lt;%= f.password_field :password, autocomplete: "new-password", class: "form-control" %>
        &lt;/div>
        &lt;div class="form-group">
          &lt;%= f.label :password_confirmation %>&lt;br />
          &lt;%= f.password_field :password_confirmation, autocomplete: "new-password", class: "form-control" %>
        &lt;/div>
        &lt;div class="actions mt-5">
          &lt;%= f.submit "Sign up", class: "btn btn-lg btn-primary btn-block" %>
        &lt;/div>
      &lt;% end %>
      &lt;%= render "devise/shared/links" %>
    &lt;/div>
  &lt;/div>
&lt;/div></code></pre>

<p>Il y a juste 6 vues à gérer pour éviter de passer pour un pouilleux si un utilisateur veut réinitialiser sont mot de passe et tombe sur un truc comme ça (#vécu) : </p>

<img src="https://i.imgur.com/qU6TAhL.png" class="img-fluid"><br>


<h3>3.5. Le mailer</h3>
<p>Le mailer est très important dans Devise. Sans ce dernier, les utilisateurs qui ont perdu leur mot de passe n'ont plus accès à ton application et c'est pas ouf. L'avantage est que si ton mailer est bien branché, tout devrait être fonctionnel, sauf une chose : il faut donner l'url de ton application pour la redirection. Je m'explique : quand tu vas recevoir un email pour récupérer ton mot de passe, l'email va te donner un lien à cliquer qui va rediriger vers ton application sur un formulaire pour changer le mot de passe. Il faut donc dire à Rails "pour la production, l'URL de mon app est : monapp.herokuapp.com". Insère donc la ligne suivante dans ton fichier <code>config/environments/production.rb</code> :</p>

<pre><code class="language-ruby">config.action_mailer.default_url_options = { :host => 'YOURAPPNAME.herokuapp.com' }</code></pre>


<h3>3.6. Quelques astuces pour être le champion de Devise</h3>
<h4>3.6.1. Convention over configuration</h4>
<p>Devise aime BEAUCOUP les conventions, et en sortir est un appel à la galère. Voici donc des astuces si jamais tu veux sortir des <i>rails</i> de Devise :</p>

<h5>3.6.1.1. Tu veux customiser un controller de Devise</h5>
<p>Changer le code source des controllers de Devise est une <b>très mauvaise</b> idée à ton niveau.</p>

<p>Imaginons que tu veux envoyer un email à un utilisateur à sa création, ou enregistrer ses infos sur un fichier Spreadsheet. Ceci est un <code>after_create</code> dans ton model et n'a rien à faire dans le controller.</p>

<p>Imaginons que tu veux rediriger sur une page spécifique après l'inscription de ton utilisateur. Au lieu de modifier le controller de Devise, ces derniers ont prévu une super méthode <code>after_sign_up_path_for</code> qui fera ceci. Tu peux trouver plus d'info <a href="https://github.com/plataformatec/devise/wiki/How-To:-Redirect-to-a-specific-page-on-successful-sign-up-(registration)" target="_blank">sur le wiki de la gem</a>, et voici <a href="https://www.youtube.com/watch?v=1FGwNzBPbPY" target="_blank">une vidéo</a> qui explique cela.</p>

<h5>3.6.1.2. Tu veux pouvoir modifier d'autres paramètres utilisateurs dans registrations/edit</h5>
<p>La page registrations/edit est une page qui change les paramètres tels que l'email, ou le mot de passe. Un peu comme la page <a href="https://github.com/settings/admin" target="_blank">settings/admin</a> de GitHub. Notre conseil est de ne mettre rien d'autre à modifier dans cette page (j'ai essayé, c'est l'enfer sur Terre).</p>

<p>Si jamais tu veux faire une page pour changer des détails comme ton code postal, ton prénom, ta description de profil, cette dernière n'ira pas dans registrations/edit, mais plutôt dans une autre page users/edit qui sera parfaitement adaptée cette demande. Un peu comme la page <a href="https://github.com/settings/profile" target="_blank">settings/profile</a> de GitHub.</p>


<h5>3.6.1.3. Autres astuces ?</h5>
<p>Le <a href="https://github.com/plataformatec/devise/wiki" target="_blank">wiki</a> de Devise a une rubrique <a href="https://github.com/plataformatec/devise/wiki/How-Tos" target="_blank">How-Tos</a> qui contient une centaine de tutoriels pour customiser Devise.</p>



<h2>4. Points importants à retenir</h2>
<p>Pour pouvoir utiliser Devise, voici la marche à suivre :</p>

<ul>
  <li>Mettre Devise dans les gems, puis faire bundle install</li>
  <li>Installer Devise en entrant la ligne <code>$ rails generate devise:install</code>
  <ul>
    <li>Si tu ne l'as pas déjà fait, il faut faire marcher les emails en local dans ton application en mettant la ligne <code>config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }</code> dans ton fichier <code>config/environments/development.rb</code></li>
  </ul></li>
  <li>Devise est installée, tu peux assigner ton model (99% du temps c'est user) à Devise : <code>$ rails g devise user</code>. Puis tu migres.</li>
  <li>Tu génères les views avec <code>$ rails generate devise:views users</code></li>
  <li>Les 5 views de Devise devront être transformées pour éviter la page de signup moche</li>
  <li>Tu as juste à appeler les views et à toi la gloire !</li>
</ul>


<h2>5. Pour aller plus loin</h2>
<p>Il existe deux autres gems qui s'occupent de l'authentification. Elles sont moins "machines à café" que Devise, mais peuvent t'intéresser si tu aimes les gems plus minimalistes :</p>

<ul>
  <li><a href="https://github.com/thoughtbot/clearance" target="_blank">Clearance</a> de Thoughbot</li>
  <li><a href="https://github.com/Sorcery/sorcery" target="_blank">Sorcery</a></li>
</ul>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>


  <div class="container">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header" style="border-top: 3px solid #FF4081 " >
          <h1>Projet : Eventbrite : Devise et premières views</h1>
          <a class="heading-elements-toggle">
          <i class="la la-ellipsis-v font-medium-3"></i>
          </a>
          <div class="heading-elements">
            <ul class="list-inline mb-0">
              <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
              <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
            </ul>
          </div> 
      </div>
      <div class="card-content collapse show">
        <div class="card-body">
          <div class="tab-pane active" id="home1" role="tabpanel">
          <h2>1. Introduction</h2>
<p>Dans ce projet, tu vas reprendre le projet de la veille pour y construire tes premières vues. Tu vas installer Devise sur ton application et construire les premières vues.</p>

<p>Plus en détails, voici ce que nous attendons de toi :</p>

<ul>
  <li>Tu dois installer Devise sur l'application, et brancher le model utilisateurs à Devise</li>
  <li>Tu vas brancher Bootstrap à ton application</li>
  <li>Tu vas faire un header qui comprend les liens importants de ton application, puis le mettre pour toutes les vues de ton application</li>
  <li>Tu vas faire la page d'accueil du site</li>
  <li>Tu vas faire la page profil d'un utilisateur</li>
  <li>Tu vas faire la page de création d'événement</li>
  <li>Tu vas faire la page qui affiche un événement</li>
</ul>

<p>Cela peut paraître flou, mais avec le REST, quelques méthodes de controllers, et un branchement Devise, ton application sera faite bien plus rapidement que la semaine qu'il t'a fallu pour l'application Gossips Project (alors que les deux applications sont très similaires). Ceci est dû principalement au fait que tu commences à gérer la fougère. Bravo ;)</p>

<h2>2. Le projet</h2>

<p>Avant de commencer, nous allons faire la première vue de l'application : la page d'accueil. Cette page d'accueil est la liste des événements de ta ville, donc l'index des villes. Génère un controller pour les événements, avec la méthode index. Branche cette méthode index à la page d'accueil du site.</p>

<h3>2.1. Branchement de Bootstrap</h3>
<p>Bootstrap te permettra d'avoir une navbar qui te permet de naviguer dans l'application. Cette navbar contiendra les liens suivants :</p>

<ul>
  <li>Lien pour accéder à l'accueil du site (et donc la liste des événements)</li>
  <li>Lien pour créer un événement (<code>events#new</code>)</li>
  <li>Liens de profil :
  <ul>
    <li>Si le visiteur n'est pas connecté, un dropdown "S'inscrire / Se connecter" avec deux liens : 
    <ul>
      <li>"S'inscrire", qui correspond à l'inscription d'un utilisateur (<code>registrations#new</code>)</li>
      <li>"Se connecter", qui correspond à une connexion d'utilisateur (<code>sessions#new</code>)</li>
    </ul></li>
    <li>Si l'utilisateur est connecté, un dropdown "Mon profil" avec deux liens :
    <ul>
      <li>"Mon profil", qui est la page qui affiche le profil de l'utilisateur <code>users#show</code></li>
      <li>"Se déconnecter", qui correspond à un logout (<code>sessions#destroy</code>)</li>
    </ul></li>
  </ul></li>
</ul>

<p>Fais donc cette navbar. Comme les routes de ces liens ne sont pas encore définies, mets <code>#</code> aux urls des liens. On les implémentera au fur et à mesure.</p>

<h3>2.2. Branchement de Devise</h3>
<p>Passons aux choses sérieuses. Nous allons passer par Devise pour toute l'authentification de ton application. Installe Devise, et fais les branchements nécessaires.</p>

<div class="card box-shadow-0 border-danger">
  <div class="card-content collapse show">
    <div class="card-body">
      <h4 class="card-title">⚠️ ALERTE ERREUR COMMUNE</h4>
      <p>Étant donné que tu as déjà créé ta classe utilisateurs, la génération du <code>g devise User</code> va créer une migration pour changer la table utilisateurs. Tu peux voir que le <code>self.down</code> de la migration génère une erreur. Il te faudra lire les commentaires de cette migration qui disent "change la migration en fonction de ce que tu veux ajouter". Je te laisse trouver un moyen pour résoudre ceci.</p>
    </div>
  </div>
</div>

<p>Une fois que Devise est branchée, nous allons brancher les vues de Devise. Devise a 5 vues à gérer :</p>

<ul>
  <li><code>app/views/devise/registrations/new.html.erb</code> : inscription au site : accessible depuis la navbar</li>
  <li><code>app/views/devise/sessions/new.html.erb</code> : connexion au site : accessible depuis la navbar</li>
  <li><code>app/views/devise/passwords/new.html.erb</code> : l'écran "mot de passe oublié ?" où tu rentres ton adresse email pour recevoir un email de réinitialisation de mot de passe : accessible grâce à la partial <code>shared_links</code></li>
  <li><code>app/views/devise/registrations/edit.html.erb</code> : l"écran pour modifier son email et son mot de passe : accessible depuis la page profil</li>
  <li><code>app/views/devise/passwords/edit.html.erb</code> : la vue où tu rentres ton nouveau mot de passe (tu y accèdes en cliquant dans le lien "réinitialiser le mot de passe" dans ton email de réinitialisation de mot de passe) : accessible depuis l'email de demande de changement de mot de passe</li>
</ul>

<p>Nous te laissons ajouter les liens d'inscription et de connexion à la navbar, puis de faire en sorte que ces 5 views affichent aussi la navbar.</p>


<p>Enfin, pour que Devise fonctionne correctement, il te faut faire le branchement du mailer. Rien de plus frustrant de faire une demande de réinitialisation de mot de passe et de ne jamais recevoir son mot de passe. Fais donc les branchements nécessaires pour que Devise envoie bien ses emails.</p>

<p>Une fois que tu as fait cela, je t'invite à te rendre compte que tu viens de réaliser un système complet d'authentification d'utilisateurs, fonctionnel et en production. C'est une excellente étape vers un site fonctionnel et tu peux être fier de toi.</p>


<h3>2.3. Faire les premières views</h3>
<p>Dans cette partie, nous allons construire les premières views pour que l'application commence à marcher :</p>

<ul>
  <li>La page d'accueil du site (<code>events#index</code>)</li>
  <li>La page profil d'un utilisateur (<code>users#show</code>)</li>
  <li>La page de création d'un événement (<code>events#new</code>)</li>
  <li>La page d'affichage d'un événement (<code>events#show</code>)</li>
</ul>

<p>Tu peux commencer à générer les controllers, leurs méthodes, et écrire les routes pour ces premières views. Bien entendu, il est interdit d'utiliser les routes en <code>GET</code>/<code>POST</code> et tu devras utiliser <code>resources</code>.</p>

<h4>2.3.1. La page d'accueil</h4>
<p>La page d'accueil du site affiche tous les événements de l'application. Pour chaque événement, tu pourras cliquer sur un lien qui t'emmènera vers la page <code>show</code> de l'événement. La page d'accueil invitera l'utilisateur à créer son événement.</p>

<p>Pour le front, on est comme d'habitudes fans <a href="https://getbootstrap.com/docs/4.0/examples/" target="_blank">des exemples</a> de Bootstrap. La page <a href="https://getbootstrap.com/docs/4.0/examples/jumbotron/" target="_blank">jumbotron</a> par exemple a l'air de bien correspondre à ce que l'on veut.</p>

<h4>2.3.2. La page profil d'un utilisateur</h4>
<p>La page profil d'un utilisateur devra afficher les informations de l'utilisateur : prénom, nom, description, email (la plupart de ces informations ne sont pas encore renseignées par l'utilisateur, mais le but de cette page est de vous faire faire ce qui va suivre).</p>

<p>La page de profil d'un utilisateur va afficher les événements qu'il a créés (<code>title</code> et liens suffiront).</p>


<p>Ensuite, la page de profil d'un utilisateur ne doit pas être accédée par deux types de personnes :</p>

<ul>
  <li>Aux visiteurs non connectés (<code>authenticate_user!</code>)</li>
  <li>Aux utilisateurs connectés, mais qui ne sont pas sur la page de leur profil (user 23 n'a pas le droit d'aller sur la page profil de user 36). Pour ceci, il te faudra coder une méthode custom</li>
</ul>

<p>En gros, elle doit être accessible uniquement par la personne concernée par cette page. La page de profil doit aussi insérer un lien pour l'édition des informations importantes (<code>registrations#new</code>).</p>


<p><b>BONUS</b> : pour ceux qui sont en GODMODE, vous pouvez ajouter un lien pour éditer les informations de profil (<code>users#edit</code>) : la description, le prénom, le nom.</p>

<h4>2.3.3. Création d'un événement</h4>
<p>À partir de la navbar (et de la page d'accueil), il est possible de créer un événement. La création d'événement demandera :</p>

<ul>
  <li>Sa <code>start_date</code></li>
  <li>Sa <code>duration</code></li>
  <li>Son <code>title</code></li>
  <li>Sa <code>description</code></li>
  <li>Son <code>price</code></li>
  <li>Sa <code>location</code> (un input normal suffira)</li>
</ul>

<p>Nous t'invitons à regarder <a href="https://getbootstrap.com/docs/4.0/components/forms/" target="_blank">la page des formulaires de Bootstrap</a> pour t'inspirer.</p>

<p>Quand un événement est créé il doit être associé au current_user. Cela veut dire que Devise devra authentifier l'utilisateur avant de pouvoir faire <code>new</code> ou <code>create</code>. Une fois l'événement créé, l'utilisateur sera redirigé vers la page <code>show</code> de l'événement.</p>

<h4>2.3.4. Afficher un événement</h4>
<p>Maintenant tu vas afficher un événement. Cette page devra montrer :</p>

<ul>
  <li>Le titre de l'événement</li>
  <li>Sa description complète</li>
  <li>Le nombre d'inscrits à l'événement</li>
  <li>Le créateur (son email suffira)</li>
  <li>Sa date début, et sa date de fin (la date de fin est une méthode d'instance)</li>
  <li>Le lieu de l'événement</li>
  <li>Son prix</li>
</ul>

<p>Demain nous verrons la page pour s'inscrire à l'événement en tant que participant.</p>

<h3>2.4. Des tests</h3>
<p>Afin d'éviter des gros soucis en production, il faudra veiller à tester son application, notamment sur les aspects importants :</p>

<ul>
  <li>Il est impossible d'accéder à la page de profil si la personne qui la voit n'est pas l'utilisateur concerné par la page (test unitaire de la méthode show du controller users)</li>
  <li>La page d'accueil doit bien afficher l'index des événements (test unitaire de la méthode index de la view events)</li>
  <li>Un visiteur non connecté ne peut pas créer d'événement (test unitaire des méthodes new et create du controller events)</li>
  <li>Enfin, un test d'intégration happy path : création d'un événement</li>
</ul>


<h2>3. Rendu attendu</h2>
<p>Avec ceci, tu as une belle application où les gens peuvent voir la liste des événements disponibles dans leur ville. C'est un excellent début et tu peux être fier de toi. Demain nous allons ajouter les fonctionnalités pour rejoindre un événement et ton application sera prête êt fonctionnelle pour être montrée à la Terre entière. À partir de jeudi on implémentera des fonctionnalités pas indispensables, mais qui vont agrémenter l'expérience utilisateur (gestion des images, interface administrateur).</p>

          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>



</div>


  </div>
</div>
    <script src="/packs/dashboard-031178fac0de4f91cbcc.js"></script>
    

    <script charset="utf-8">
      $('input[name=authenticity_token]').val($('meta[name=csrf-token]').attr('content'));
    </script>

  </body>
</html>
