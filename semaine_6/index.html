<!DOCTYPE html>
<html class="loading" lang="fr">
  <head>
  <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="../style/bootstrap.css">
    <title>The hacking project offline</title>
  </head>
  <body class="vertical-layout vertical-menu 2-columns  menu-expanded fixed-navbar" data-open="click" data-menu="vertical-menu" data-color="bg-gradient-x-primary-blue" data-col="2-columns">
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <h1 class="navbar-brand">THE HACKING PROJECT</h1>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor01">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="../">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../features">Features</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../about">About</a>
            </li>
          </ul>
          <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="text" placeholder="Search">
            <button class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
          </form>
        </div>
      </nav>

<div class="container">
    <a type="button" class="btn btn-dark " href="../semaine_1/">Semaine 1</a>
    <a type="button" class="btn btn-dark" href="../semaine_2/">Semaine 2</a>
    <a type="button" class="btn btn-dark" href="../semaine_3/">Semaine 3</a>
    <a type="button" class="btn btn-dark" href="../semaine_4/">Semaine 4</a>
    <a type="button" class="btn btn-dark" href="../semaine_5/">Semaine 5</a>
    <a type="button" class="btn btn-dark btn-lg" href="../semaine_6/">Semaine 6</a>  
</div>

<div class="app-content content">
  <div class="content-wrapper">
    <div class="content-wrapper-before"></div>
    <div class="content-header row"></div>
    
      <div class="container">
    <div class="card">
  <div class="card-header">
    <h4 class="text-center"> Programme jour par jour</h4>
  </div>
  <div class="card-body">
    <div class="text-center">
    <a href="../semaine_6">
      <button class="btn btn-secondary btn-outline-dark btn-lg mr-4">
        <i class="fa fa-terminal"></i>&nbsp;&nbsp;&nbsp;Lun
      </button>
</a>    <a href="../semaine_6/jour_2">
      <button class="btn btn-secondary btn-outline-dark btn mr-4">
        <i class="fa fa-code"></i>&nbsp;&nbsp;&nbsp;Mar
      </button>
</a>    <a href="../semaine_6/jour_3">
      <button class="btn btn-secondary btn-outline-dark btn mr-4">
        <i class="fa fa-desktop"></i>&nbsp;&nbsp;&nbsp;Mer
      </button>
</a>    <a href="../semaine_6/jour_4">
      <button class="btn btn-secondary btn-outline-dark btn mr-4">
      <i class="fa fa-folder-open"></i>&nbsp;&nbsp;&nbsp;Jeu
      </button>
</a>    <a href="../semaine_6/jour_5">
      <button class="btn btn-secondary btn-outline-dark btn mr-4">
      <i class="fa fa-bullhorn"></i>&nbsp;&nbsp;&nbsp;Ven
      </button>
</a>    </div>
  </div>
</div>

<div class="app-content content">
  <div class="content-wrapper">
    <div class="content-wrapper-before"></div>
    <div class="content-header row"></div>
    
      
<div class="content-body">
      <h2 class="text-center">Mailer et Ã©vÃ©nements</h2>
      <h4 class="text-center">Rails avancÃ©</h4>
  <div class="row">
     <div class="col-xl-3 col-lg-6 col-md-12">
  <div class="card">
    <div class="card-content">
      <div class="card-body">
        <div class="media d-flex">
          <div class="align-self-top">
              <i class="ft-calendar icon-opacity info font-large-4"></i>
          </div>
          <div class="media-body text-right align-self-bottom mt-3">
              <span class="d-block mb-1 font-medium-1"></span>
              <h3 class="info mb-0">
                 Jour 25 / 55</h3>
          </div>
        </div>
        <div class="progress progress-sm mt-1 mb-0 box-shadow-2">
            <div class="progress-bar bg-gradient-x-info" role="progressbar" style="width: 45%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="120">
            </div>
        </div>
      </div>
    </div>
  </div>
 </div>


    <div class="col-xl-3 col-lg-6 col-md-12">
  <div class="card">
    <div class="card-content">
      <div class="card-body">
        <div class="media d-flex">
          <div class="align-self-top">
            <i class="ft-heart icon-opacity danger font-large-4"></i>
          </div>
          <div class="media-body text-right align-self-bottom mt-3">
            <span class="d-block mb-1 font-medium-1">Jokers restant</span>
            <h3 class="danger mb-0">
                3
            </h3>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

    <div class="col-xl-3 col-lg-6 col-md-12">
    <div class="card">
        <div class="card-content">
            <div class="card-body">
                <div class="media d-flex">
                    <div class="align-self-top">
                        <a href="/dashboard/assignments?locale=fr">
                           <i class="ft-fast-forward icon-opacity warning font-large-4"></i>
</a>                    </div>
                    <div class="media-body text-right align-self-bottom mt-3">
                        <span class="d-block mb-1 font-medium-1">Missions</span>
                            <div class="badge border-danger danger badge-border">Pas inscrit</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

  </div>
  <div class="row">
        <div class="container">
    <div class="col-xl-12 col-lg-12 col-md-12">
    <div class="card">
        <div class="card-header">
        <h1 >Rails avancÃ©
                <i class="fa fa-space-shuttle text-danger"></i>
        </h1>
        
        </div>
        <div class="card-content">
        <div class="card-body">
            <div class="card-text">
            <h2 class="text-center">Mailer et Ã©vÃ©nements</h2>
            <div class="cd-horizontal-timeline loaded">
                <div class="timeline">
                <div class="events-wrapper">
                    <div class="events" style="width: 1800px;">
                    <ol>
                            <li>
                                <a class="selected" style="left:120px;" data-toggle="tooltip" data-placement="top" title="Mailer et Ã©vÃ©nements" href="/dashboard/weeks/6/days/1?locale=fr">
                                    Lun
                                        <i class="fa fa-rocket text-danger" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Projet Ã  rendre ce jour-lÃ "></i>

</a>                                </li>
                                <li>
                                    <a style="left:240px;" href="/dashboard/weeks/6/days/2?locale=fr">
                                        Mar
                                            <i class="fa fa-pencil text-success" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Corrections cette journÃ©e lÃ " ></i>


</a>                                </li>
                                <li>
                                <a href="#" style="left: 360px;">
                                    Mer
                                    <i class="fa fa-lock fa-margin" aria-hidden="true"></i>
                                        <i class="fa fa-rocket text-danger" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Projet Ã  rendre ce jour-lÃ "></i>

                                </a>
                                </li>
                                <li>
                                <a href="#" style="left: 480px;">
                                    Jeu
                                    <i class="fa fa-lock fa-margin" aria-hidden="true"></i>
                                        <i class="fa fa-pencil text-success" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Corrections cette journÃ©e lÃ " ></i>


                                </a>
                                </li>
                                <li>
                                <a href="#" style="left: 600px;">
                                    Ven
                                    <i class="fa fa-lock fa-margin" aria-hidden="true"></i>
                                        <i class="fa fa-beer text-warning" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="Rendez-vous pour boire un coup"></i>

                                </a>
                                </li>
                    </ol>
                </div>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>
    </div>
<div>
  </div>

  <!-- Les fameuses corrections qui n'arrivnet que les jours concernÃ©s -->


    <div class="container">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header" style="border-top: 3px solid #5E66E5 " >
          <h1>Cours : L&#39;Action Mailer</h1>
          <a class="heading-elements-toggle">
          <i class="la la-ellipsis-v font-medium-3"></i>
          </a>
          <div class="heading-elements">
            <ul class="list-inline mb-0">
              <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
              <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
            </ul>
          </div> 
      </div>
      <div class="card-content collapse show">
        <div class="card-body">
          <div class="tab-pane active" id="home1" role="tabpanel">
          
<h2>1. Introduction</h2>
<p>Rails dispose d'un outil de gestion des envois d'e-mail plutÃ´t bien conÃ§uÂ : Action Mailer. GrÃ¢ce Ã  lui, tu vas pouvoir automatiser l'envoi de certains e-mails selon les critÃ¨res que tu dÃ©finiras (actions de tes utilisateurs, Ã©vÃ©nements ou alertes donnÃ©es, etc..). Nous allons donc t'apprendre Ã  paramÃ©trer Action Mailer et Ã  l'utiliser de faÃ§on automatisÃ©e.</p>


<h2>2. Historique et contexte</h2>
<p>Les e-mails sont, de nos jours, partie intÃ©grante de l'expÃ©rience utilisateur d'un site web moderne. Sans eux, impossible de garder le contact avec tes utilisateurs, leur faire changer de mot de passe ou encore les prÃ©venir d'un Ã©vÃ¨nement important liÃ© Ã  leurs comptes (nouveau commentaireÂ ? nouveau messageÂ ?). Maintenant que tu sais poser les bases d'une application Rails complÃ¨te (routes, models, views et controllers), on va lui ajouter les fonctionnalitÃ©s additionnelles qui en feront un service fonctionnel et professionnel.</p>

<h2>3. La ressource</h2>

<h3>3.1. Les concepts de base de l'Action Mailer</h4>
<p>L'Action Mailer est organisÃ© en plusieurs Ã©lÃ©mentsÂ au sein d'une app Rails : </p>
<ol>
  <li><b>Des mailers</b>, qui sont ni plus ni moins que des sortes de controllers appliquÃ©s aux e-mails. Tout comme les controllers "normaux", ils contiennent des mÃ©thodes qui vont faire des appels Ã  la BDD (via les models) et ensuite envoyer des e-mails (au lieu d'envoyer des pages web Ã  des navigateurs). </li>
  <li><b>Des views</b>, qui sont des sortes de templates des e-mails Ã  envoyer. Tout comme les views de ton site, elles sont personnalisÃ©es grÃ¢ce Ã  du code Ruby inclus dedans (pour rajouter un nom, un e-mail, le contenu d'un objet rÃ©cupÃ©rÃ© en BDD, etc.). Il existe deux types de views : les <code>.text.erb</code> et les <code>.html.erb</code> car on peut envoyer des e-mails au format HTML comme au format text.</li>
</ol>

<p>Au final, il faut considÃ©rer qu'Action Mailer a un fonctionnement trÃ¨s proche du MVC classique de Rails sauf qu'au lieu d'afficher des pages HTML sur un navigateur, il envoie des fichiers HTML ou text par e-mail.</p>

<h3>3.2. Mettre en place ton premier Action Mailer</h3>
<p>Afin d'apprendre Ã  te servir de ce service, on te propose de pratiquer directement.</p>

<h4>3.2.1. Les bases pour bosser</h4>
<p> Commence par prÃ©parer tout ce qu'il faut pour disposer d'une application de testÂ : </p>
<ul>
  <li>GÃ©nÃ¨re une application Rails <code>test_action_mailer</code>Â ;</li>
  <li>CrÃ©e-lui un model <code>User</code> avec des champs <code>name</code> (string) et <code>email</code> (string)Â ;</li>
  <li>CrÃ©e une BDD (si tu es en PostGre) et passe la migration.</li>
</ul>

<h4>3.2.2. Ton premier mailer</h4>
<p>Ã€ prÃ©sent, on va gÃ©nÃ©rer un mailer avec <code>$ rails g mailer UserMailer</code>. On l'a appelÃ© <code>UserMailer</code> dans l'idÃ©e qu'Ã  terme, il pourrait gÃ©rer tous les e-mails Ã  destination des utilisateurs. On pourrait aussi avoir un <code>AdminMailer</code> qui enverrait les e-mails aux gestionnaires du site.</p>
<p>Maintenant, jette un Å“il au mailer que tu viens de gÃ©nÃ©rer dans <code>app/mailers/user_mailer.rb</code>Â : il est vide mais hÃ©rite de <code>ApplicationMailer</code> que tu pourras retrouver Ã  <code>app/mailers/application_mailer.rb</code>. </p>

<p>On va Ã©diter le mailer pour rajouter une mÃ©thode dont le rÃ´le sera simpleÂ : envoyer un e-mail de bienvenue Ã  tous les utilisateurs s'inscrivant sur notre site. Rajoute donc les lignes suivantesÂ : </p>

<pre><code class="language-ruby">class UserMailer < ApplicationMailer
  default from: 'no-reply@monsite.fr'
 
  def welcome_email(user)
    #on rÃ©cupÃ¨re l'instance user pour ensuite pouvoir la passer Ã  la view en @user
    @user = user 

    #on dÃ©finit une variable @url qu'on utilisera dans la view dâ€™e-mail
    @url  = 'http://monsite.fr/login' 

    # c'est cet appel Ã  mail() qui permet d'envoyer lâ€™e-mail en dÃ©finissant destinataire et sujet.
    mail(to: @user.email, subject: 'Bienvenue chez nous !') 
  end
end</code></pre><br>

<p>La premiÃ¨re ligne permet de dÃ©finir la valeur de <code>default[:from]</code>. Le hash <code>default</code> permet de dÃ©finir tout un ensemble de valeurs par dÃ©fautÂ : celles-ci sont Ã©crasÃ©es si la mÃ©thode d'envoi dâ€™e-mail dÃ©fini une valeur autre. Ici, l'objectif est que nos e-mails affichent toujours une adresse dâ€™e-mail d'envoiÂ : soit celle dÃ©finie par la mÃ©thode du mailer, soit, Ã  dÃ©faut, <code>no-reply@monsite.fr</code>.</p>

<h4>3.2.3. Ta premiÃ¨re mailer view</h4>
<p>On va crÃ©er le template de notre e-mail de bienvenue. <br>
Pour Ã§a, crÃ©e un fichier <code>welcome_email.html.erb</code> dans <code>app/views/user_mailer/</code>. Bien Ã©videmment le nom est extrÃªmement importantÂ : il doit Ãªtre identique Ã  celui de la mÃ©thode <code>welcome_email</code> et placÃ© dans le dossier <code>views/user_mailer/</code> qui contient tous les templates e-mails relatifs au mailer <code>UserMailer</code>. Le contenu du template sera le suivant :</p>

<pre><code class="language-html">&lt;!DOCTYPE html>
&lt;html>
  &lt;head>
    &lt;meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
  &lt;/head>
  &lt;body>
    &lt;h1>Salut <%= @user.name %> et bienvenue chez nousÂ !&lt;/h1>
    &lt;p>
      Tu t'es inscrit sur monsite.fr en utilisant l'e-mail suivantÂ : <%= @user.email %>.<br>
    &lt;/p>
    &lt;p>
      Pour accÃ©der Ã  ton espace client, connecte-toi viaÂ : <%= @url %>.
    &lt;/p>
    &lt;p> Ã€ trÃ¨s vite sur monsite.frÂ !</p>
  &lt;/body>
&lt;/html></code></pre>

<p>On va aussi prÃ©voir une version texte pour les utilisateurs qui n'aiment pas les e-mails en HTML. C'est toujours mieux de prÃ©voir les deuxÂ ! Pour cela, crÃ©e Ã©galement un fichier <code>welcome_email.text.erb</code> dans <code>app/views/user_mailer/</code> et son contenu sera le suivant :</p>

<pre><code class="language-text">Salut <%= @user.name %> et bienvenue chez nousÂ !
==========================================================
 
Tu t'es inscrit sur monsite.fr en utilisant l'e-mail suivantÂ : <%= @user.email %>.
 
Pour accÃ©der Ã  ton espace client, connecte-toi viaÂ : <%= @url %>.
 
Ã€ trÃ¨s vite sur monsite.frÂ !</code></pre>

<h4>3.2.4. DÃ©finir l'envoi automatique</h4>
<p>Tout est prÃªt cÃ´tÃ© Action MailerÂ : il ne reste plus qu'Ã  dÃ©finir Ã  quel moment notre app Rails doit effectuer l'envoi. Pour ceci, voici quelques exemples de cas :</p>

<ul>
  <Li>Si tu veux envoyer un email Ã  la crÃ©ation d'un utilisateur, c'est un callback <code>after_create</code> dans le model User</Li>
  <Li>Si tu veux envoyer un email quand un utilisateur vient de prendre un RDV sur Doctolib, c'est un callback <code>after_create</code> Ã  la crÃ©ation d'un Appointment</Li>
  <Li>Si tu veux envoyer une newsletter hebdomadaire, c'est un Service qui tourne de maniÃ¨re hebdomadaire (on verra comment faire des services cette semaine ğŸ˜‰)</Li>
  <Li>Un email pour rÃ©initialiser le mot de passe peut se mettre dans le controller</Li>
</ul>



<p>Dans notre cas, on veut envoyer un e-mail juste aprÃ¨s la crÃ©ation d'un utilisateurÂ : il serait logique que ce travail revienne au model car 1) c'est lui qui crÃ©e l'utilisateur donc autant qu'il fasse les 2 actions et 2) Fat model Skinny controller, duuuuuudeÂ ! ğŸ•º </p>

<p>Du coup, va dans ton model <code>User</code> et rajoute la ligne suivanteÂ : </p>


<pre><code class="language-ruby">class User < ApplicationRecord
  after_create :welcome_send

  def welcome_send
    UserMailer.welcome_email(self).deliver_now
  end

end</code></pre><br>

<p>On a utilisÃ© un callback qui permet <b>juste aprÃ¨s</b> l'inscription en base d'un nouvel utilisateur, d'appeler la mÃ©thode d'instance <code>welcome_send</code>. Celle-ci ne fait qu'appeler le mailer <code>UserMailer</code> en lui faisant exÃ©cuter <code>welcome_email</code> avec, pour seule entrÃ©e, l'instance crÃ©Ã©e (d'oÃ¹ le <code>self</code>).</p>

<p>Ã€ noter qu'on rajoute ensuite un <code>deliver_now</code> pour envoyer immÃ©diatement lâ€™e-mail. Il est possible d'utiliser un <code>deliver_later</code> mais son fonctionnement en production est moins Ã©videntÂ : il faut savoir gÃ©rer les tÃ¢ches asynchrones avec Active Jobâ€¦ On ne va pas rentrer lÃ -dedans pour le moment.</p>

<p>En rÃ©sumÃ©, nous venons de paramÃ©trer la chaÃ®ne d'actions suivanteÂ : </p>
<ol>
  <li>Un utilisateur est crÃ©Ã© en BDD par le model</li>
  <li>GrÃ¢ce au callback <code>after_create</code>, on exÃ©cute la mÃ©thode <code>welcome_send</code> sur l'instance qui vient d'Ãªtre sauvÃ©e en BDD</li>
  <li><code>welcome_send</code> dit, en rÃ©sumÃ©, "exÃ©cute NOW la mÃ©thode <code>welcome_email</code> situÃ©e dans le mailer <code>UserMailer</code>" </li>
  <li><code>welcome_email</code> va appeler 2 templates en leur mettant Ã  disposition une instance <code>@user</code> qui est l'utilisateur crÃ©Ã© et une variable <code>@url</code> qui est juste un string. Cette mÃ©thode enverra ensuite les 2 templates Ã  <code>@user.email</code> avec comme sujet "Bienvenue chez nous".</li>
  <li>Les 2 templates (un HTML et un text) sont personnalisÃ©s avec les entrÃ©es en Ruby (<code>@user.name</code>, <code>@user.email</code> et <code>@url</code>) avant d'Ãªtre balancÃ©s par e-mail </li>
  <li>Et voilÃ Â ! ğŸ‘©â€ğŸ³ </li>
</ol>

<p>Pourtant, si tu fais le test en crÃ©ant en console un utilisateur, Ã  part le template e-mail qui s'affiche dans le terminal, tu ne verras rien de trÃ¨s concret. En effet, Rails n'est pas en mesure d'envoyer comme Ã§a des e-mails sans disposer d'un serveur SMTP configurÃ©Â ! C'est notre prochaine Ã©tape.</p>

<h3>3.3. Configurer les paramÃ¨tres d'Action Mailer</h3>
<p>Tu sais maintenant comment mettre en place un Action Mailer de baseÂ : il est temps de le paramÃ©trer pour qu'il puisse envoyer des e-mails pour de vrai. Dans Rails, on peut dÃ©finir les paramÃ¨tres selon l'environnement dans lequel notre application tourne :</p>
<ul>
  <li>Si elle tourne <b>en environnement de dÃ©veloppement</b> (c'est le mode par dÃ©faut quand tu lances le serveur sur ton ordi), tu veux pouvoir tester l'affichage de lâ€™e-mail mais Ã©viter de spammer les utilisateurs avec tes tests.</li>
  <li>Si elle tourne <b>en environnement de production</b> (c'est le mode par dÃ©faut sur Heroku. Tu peux aussi le lancer depuis ton ordi), lÃ  tu veux que les e-mails soient envoyÃ©s pour de vrai.</li>
</ul>

<h4>3.3.1. La config en dÃ©veloppement</h4>
<p>Ici le cahier des charges serait le suivantÂ : on veut pouvoir </p>
<ul>
  <li>vÃ©rifier que notre app Rails dÃ©clenche bien des envois dâ€™e-mails (=> Ã§a confirmerait que la chaÃ®ne entiÃ¨re dâ€™Action Mailer est bien codÃ©e et sans bug)Â ;</li>
  <li>vÃ©rifier la tronche des e-mails qu'on envoieÂ ;</li>
  <li>ne surtout pas envoyer des e-mails par erreur, histoire de ne pas prendre le risque de spammer de vrais clients pendant nos tests.</li>
</ul> 

<p>Pour Ã§a on va utiliser une gem assez cool qui s'appelle <a href="https://github.com/ryanb/letter_opener" target="_blank" class="text-primary">Letter Opener</a>. Son fonctionnementÂ ? DÃ¨s qu'un e-mail doit Ãªtre envoyÃ© par ton app Rails, celui-ci est automatiquement ouvert dans ton navigateur web. </p>
<p>Testons-la immÃ©diatement sur ton app <code>test_action_mailer</code>Â : </p>
<ul>
  <li>Mets <code>letter_opener</code> dans le groupe de dÃ©veloppement de ton Gemfile puis bundle install</li>
  <li>Maintenant va dans <code>config/environments/development.rb</code> (fichier contenant les paramÃ¨tres de ton environnement de dÃ©veloppement) et colle les lignes <code>config.action_mailer.delivery_method = :letter_opener</code> et <code>config.action_mailer.perform_deliveries = true</code></li>
</ul>
<p><b>Note importante</b>Â : la ligne avec <code>perform_deliveries = true</code> permet d'Ã©teindre (en la passant Ã  <code>false</code>) tout envoi d'email de la part de ton app Rails. C'est bon de savoir qu'elle existeÂ !</p>

<p>Maintenant que la gem est installÃ©e et configurÃ©e, va dans la console Rails et crÃ©Ã© un utilisateur Ã  la volÃ©e (par exempleÂ : <code>User.create(name:"FÃ©fÃ©", email: "fÃ©fÃ©@yopmail.com")</code>). Tu devrais voir un visuel de lâ€™e-mail que tu as rÃ©digÃ© en HTML s'afficher dans ton navigateurÂ ! Si ce n'est pas le cas, tu as ratÃ© une Ã©tape de mon pas Ã  pasâ€¦ </p>

<h4>3.3.2. La config en production</h4>
<h5>a) Choisir un service d'envoi</h5>
<p>Ici, le cahier des charges est simpleÂ : on veut pouvoir envoyer des vrais e-mails. C'est tout.</p>

<p>Pour le faire, tu as le choix entre plein de services diffÃ©rentsÂ : Mandrill by MailChimp, Postmark, Amazon SES, etc. Nous, on a une prÃ©fÃ©rence pour <a href="https://www.mailjet.com/">MailJet</a> Ã  THP (ils sont efficaces, pas chers et franÃ§ais ğŸ‡«ğŸ‡· ğŸ“).</p>

<p>Toutefois, pour des raisons de fiabilitÃ© dâ€™envoi depuis des adresses gratuites ou fake, je vais te montrer comment passer par le leader du secteurÂ : SendGrid. Commence par crÃ©er un compte sur <a href="https://signup.sendgrid.com/">https://signup.sendgrid.com/</a>Â : indique un site web bidon, prÃ©cise que tu es dÃ©veloppeur et dis que tu vas utiliser leur SMTP/API. Ensuite va sur <a href="https://app.sendgrid.com/guide/integrate/langs/smtp">https://app.sendgrid.com/guide/integrate/langs/smtp</a> et crÃ©e une clef API.</p>

<h5>b) Sauver la clef d'API de faÃ§on sÃ©curisÃ©e</h5>
<p>Une fois cette clef en main, il faut la mettre en sÃ©curitÃ© dans ton app Rails. Pour Ã§a, rien de mieux que la gem dotenv appliquÃ©e Ã  RailsÂ ! Voici les Ã©tapes :</p>

<ul>
  <li>CrÃ©e un fichier <code>.env</code> Ã  la racine de ton application.</li>
  <li>Ouvre-le et Ã©cris dedans les informations suivantes : <code>SENDGRID_LOGIN='apikey'</code> et <code>
SENDGRID_PWD='ta_clef_API'</code> en remplaÃ§ant bien sÃ»r ta_clef_API par la clef que tu viens de gÃ©nÃ©rer. Elle est au format <code>SG.sXPeH0BMT6qwwwQ23W_ag.wyhNkzoQhNuGIwMrtaizQGYAbKN6vea99wc8</code>. N'oublie pas les guillemetsÂ !</li>
  <li>Rajoute <code>gem 'dotenv-rails'</code> Ã  ton Gemfile et fait le <code>$ bundle install</code></li>
  <li>Et l'Ã©tape cruciale qu'on oublie trop souventÂ : ouvre le fichier <code>.gitignore</code> Ã  la racine de ton app Rails et Ã©cris <code>.env</code> dedans.</li>
</ul>

<h5>c) ParamÃ©trer le SMTP avec les infos de SendGrid</h5>
<p>ParfaitÂ : tu as une clef API de SendGrid et tu es prÃªt Ã  l'utiliser. Il ne te reste qu'Ã  entrer les configurations SMTP de SendGrid dans ton app. Va dans <code>/config/environment.rb</code> et rajoute les lignes suivantesÂ : </p>

<pre><code class="language-ruby">ActionMailer::Base.smtp_settings = {
  :user_name => ENV['SENDGRID_LOGIN'],
  :password => ENV['SENDGRID_PWD'],
  :domain => 'monsite.fr',
  :address => 'smtp.sendgrid.net',
  :port => 587,
  :authentication => :plain,
  :enable_starttls_auto => true
}</code></pre><br>

<h5>d) Tester l'envoi</h5>
<p>Tout est prÃªt Ã  prÃ©sentÂ ! Si ton site web est dÃ©ployÃ© en production sur Heroku, tu peux faire un test en crÃ©ant un nouvel utilisateur. Mais comme c'est un peu fastidieux, tu peux faire plus simple en testant une fois l'envoi directement depuis l'environnement de dÃ©veloppement.</p>
<ul>
  <li>EnlÃ¨ve la ligne <code>config.action_mailer.delivery_method = :letter_opener</code> du fichier <code>config/environments/development.rb</code>Â ;</li>
  <li>Va dans ta console RailsÂ ;</li>
  <li>CrÃ©Ã© un utilisateur avec une adresse en @yopmail.comÂ ;</li>
  <li>Va vÃ©rifier que lâ€™e-mail est bien arrivÃ© sur <a href="http://www.yopmail.com/">http://www.yopmail.com/</a>.</li>
</ul>

<div class="card box-shadow-0 border-danger">
  <div class="card-content collapse show">
    <div class="card-body">
      <h4 class="card-title">âš ï¸ ALERTE ERREUR COMMUNE</h4>
      <p class="card-text">Ces services d'envois en masse ont Ã©tÃ© conÃ§us pour envoyer des e-mails <b>depuis des domaines propriÃ©taires</b>. Si tu ne possÃ¨des pas un nom de domaine (genre "thehackingprojet.org"), tu vas devoir utiliser un destinataire soit fake ("no-reply@monsite.fr") soit gratuit (@yahoo ou @gmail). Dans les deux cas, tes e-mails vont Ãªtre vite considÃ©rÃ©s comme du spam et tout simplement rejetÃ©s par la majoritÃ© des serveurs e-mailsâ€¦</p>
      <p>Seule solution pour tester ton codeÂ : viser des adresses du genre @yopmail.com qui sont habituÃ©es Ã  servir de poubelle et du coup, elles acceptent toutÂ !</p>
    </div>
  </div>
</div>

<p>SendGrid propose une super interface pour visualiser le statut des e-mails que tu as envoyÃ© via ton appli et Ã  travers leur SMTPÂ : <a href="https://app.sendgrid.com/email_activity">https://app.sendgrid.com/email_activity</a>. En cliquant sur "Search", tu peux lister e-mail par e-mail l'Ã©tat de leur envoi et de leur rÃ©ception. Parfait pour voir si ton app communique bien avec eux, mÃªme si tes e-mails se font rejeter comme Ã©tant du spam (Ã§a ne devrait pas arriver en Ã©crivant Ã  une adresse en @yopmail.com).</p>

<h5>e) Et si je veux envoyer des e-mails qui ne soient pas considÃ©rÃ©s comme du spamÂ ? </h5>
<p>Comme je te l'ai expliquÃ©, la solution propre, c'est d'acheter un nom de domaine et de le paramÃ©trer dans SendGridâ€¦</p>

<p>Une autre solution, qui n'est pas applicable pour une "vraie" sociÃ©tÃ©, est de ne pas passer par SendGrid mais directement par la configuration SMTP de ton adresse mail perso. Par exemple, pour envoyer des e-mails via ton adresse Gmail, il te faut remplacer la configuration SMTP de Sendgrid par les lignes suivantes dans <code>/config/environment.rb</code> </p>

<pre><code class="language-ruby">ActionMailer::Base.smtp_settings =   {
    :address            => 'smtp.gmail.com',
    :port               => 587,
    :domain             => 'gmail.com', #you can also use google.com
    :authentication     => :plain,
    :user_name          => ENV['GMAIL_LOGIN'],
    :password           => ENV['GMAIL_PWD']
  }</code></pre>

<p>Ã‰videmment, il faut que tu rajoutes dans ton fichier <code>.env</code> ton login Gmail et ton mot de passe sous la forme <code>ENV['GMAIL_LOGIN'] = 'jose@gmail.com'</code> et <code>ENV['GMAIL_PWD'] = 'p1rouette_KKouette'</code>.</p>

<h2>4. Points importants Ã  retenir</h2>
<p>Action Mailer est un outil efficace et bien organisÃ© d'envoi des e-mails via une app Rails.</p>
<p>Il se base sur 2 Ã©lÃ©ments principauxÂ : les <b>mailers</b> (sorte de controllers d'envoi d'e-mails) et les <b>mailer views</b> (sortes de template d'e-mails).</p>
<p>Une fois un mailer <code>UserMailer</code>gÃ©nÃ©rÃ©, on peut lui rajouter une mÃ©thode <code>welcome_email</code> qui dÃ©clenchera l'envoi de 2 templatesÂ : <code>app/views/user_mailer/welcome_email.html.erb</code> et <code>app/views/user_mailer/welcome_email.text.erb</code></p>
<p>Reste Ã  effectuer cet envoi depuis un model ou un controller (selon l'usage) grÃ¢ce Ã , par exemple, <code>UserMailer.welcome_email(user).deliver_now</code></p>
<p>En dÃ©veloppement, on utilisera la <code>gem "letter_opener"</code> pour visualiser dans son navigateur le rendu visuel des e-mails envoyÃ©s.</p>
<p>En production, il faudra paramÃ©trer un serveur SMTP dans <code>/config/environment.rb</code> pour faire cet envoi. IdÃ©alement via un service pro (Mailjet / SendGrid / etc.), ou sinon via une adresse perso dans le cas d'un projet THP.</p>

<h2>5. Pour aller plus loin</h2>
<p>Voici quelques ressources pour savoir se servir de l'Action Mailer</p>
<ul>
  <li>Tu peux regarder <a href="https://www.grafikart.fr/formations/ruby-on-rails/actionmailer" target="_blank" class="text-primary">la vidÃ©o</a> de Grafikart Ã  ce sujet. Comme d'hab, il va assez loin, mais c'est une bonne intro au sujet.</li>
  <li><a href="http://guides.rubyonrails.org/action_mailer_basics.html" target="_blank" class="text-primary">La doc</a> a prÃ©vu une bonne explication de l'Action Mailer. D'ailleurs tu verras que mon pas Ã  pas s'inspire largement de la doc ğŸ˜‡.</li>
  <li>SitePoint ont fait un <a href="https://www.sitepoint.com/fun-sending-mail-rails/" target="_blank" class="text-primary">un bon tutoriel</a> qui va assez loin lui aussi.</li>
</ul>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>


  <div class="container">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header" style="border-top: 3px solid #FF4081 " >
          <h1>Projet : Eventbrite : introduction et backend</h1>
          <a class="heading-elements-toggle">
          <i class="la la-ellipsis-v font-medium-3"></i>
          </a>
          <div class="heading-elements">
            <ul class="list-inline mb-0">
              <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
              <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
            </ul>
          </div> 
      </div>
      <div class="card-content collapse show">
        <div class="card-body">
          <div class="tab-pane active" id="home1" role="tabpanel">
          <h2>1. Introduction</h2>
<p>Cette semaine tu vas faire projet fil rouge qui t'accompagneras tout du long. Ã€ la fin tu auras une application fonctionnelle en production, que tu pourras utiliser. L'application sera une version dans ta ville de Eventbrite : les utilisateurs pourront crÃ©er des Ã©vÃ©nements, fixer un prix, mettre en ligne une photo de profil, puis les visiteurs de l'application pourront rejoindre les Ã©vÃ©nements en payant le prix. Bien entendu, il y aura une gestion d'utilisateurs avec login / logout, et on a mÃªme prÃ©vu une interface administrateur pour valider les Ã©vÃ©nements de l'application.</p>

<h2>2. Le projet</h2>
<h3>2.1. Specs du projet et agenda de la semaine</h3>
<h4>2.1.1. Specs du projet</h4>
<p>L'application sera une version minimaliste (mais fonctionnelle, c'est le plus important) d'<a href="https://www.eventbrite.fr/" target="_blank">Eventbrite</a>, un site qui propose plein d'Ã©vÃ©nements que tu peux rejoindre. Les Ã©vÃ©nements ne concernent qu'une seule ville, la ville oÃ¹ tu te trouves. Voici ce que tu peux faire :</p>

<ul>
  <li>En arrivant sur la page d'accueil, un visiteur a accÃ¨s aux Ã©vÃ©nements. Un header donne un lien d'accÃ¨s aux pages importantes : accueil, crÃ©er un Ã©vÃ©nement, s'inscrire / se connecter, mon profil</li>
  <li>Il est possible de s'inscrire sur le site avec une adresse email</li>
  <li>Une personne inscrite sur le site peut proposer un Ã©vÃ©nement. Il renseignera le titre, une description, une date de dÃ©but, une durÃ©e, un prix</li>
  <li>Sur la page qui affiche les Ã©vÃ©nements, tu verras les infos de l'Ã©vÃ©nement (description, date, durÃ©e, prix, nombre de participants)</li>
  <li>Une personne connectÃ©e peut rejoindre un Ã©vÃ©nement. Elle va cliquer sur un lien pour accÃ©der Ã  un formulaire d'inscription Ã  un Ã©vÃ©nement. Sur ce formulaire on donnera son prÃ©nom, nom, et on mettra son numÃ©ro de carte bleue pour payer l'Ã©vÃ©nement</li>
  <li>Une personne qui a crÃ©Ã© un Ã©vÃ©nement peut accÃ©der Ã  une page qui affiche la liste des invitÃ©s. Ã€ partir de cette page, ils peuvent accÃ©der Ã  une page pour Ã©diter l'Ã©vÃ©nement, voir avoir le bouton pour le supprimer</li>
  <li>Chaque utilisateur aura une page profil, avec ses informations de base (prÃ©nom, nom, description). Si un utilisateur est sur <b>sa</b> page profil, il a accÃ¨s Ã  deux liens : un pour Ã©diter ses informations primordiales (email, mot de passe) avec le bouton pour supprimer son compte, l'autre pour Ã©diter les informations de profil telles que le prÃ©nom, le nom, ou la description</li>
  <li>Actions impossibles Ã  faire si la personne n'est pas connectÃ©e : rejoindre un Ã©vÃ©nement, crÃ©er un Ã©vÃ©nement, accÃ©der Ã  la page "mon profil"</li>
</ul>

<p>Voici l'application en dÃ©tail. Nous verrons jeudi et vendredi comment ajouter une photo de profil aux Ã©vÃ©nements et aux utilisateurs, ainsi qu'une interface administrateur pour valider ou pas les Ã©vÃ©nements proposÃ©s par les utilisateurs. En gros c'est juste un scaffold dans un scaffold. Mais si tu sais bien les implÃ©menter, tu auras un site fonctionnel et prÃªt Ã  l'utilisation. Tu seras prÃªt Ã  concurrence <a href="https://www.onvasortir.com/" target="_blank">OnVaSortir</a> !</p>


<h4>2.1.2. Agenda de la semaine</h4>
<p>Voici ce que nous attendrons de toi cette semaine :</p>

<ul>
  <li><b>Lundi</b> : avant de faire les champions des views, tu vas crÃ©er la base de donnÃ©es. Ensuite tu vas brancher un mailer pour avoir un systÃ¨me d'emails fonctionnel en production</li>
  <li><b>Mardi</b> : nous allons mettre en place un systÃ¨me de gestion d'utilisateurs avec Devise (sessions, logins, inscription, etc), puis tu vas faire les premiÃ¨res views du site. En gros, tu feras en une journÃ©e ce que tu as mis une semaine Ã  faire lors de The Gossip Project. Quel champion !</li>
  <li><b>Mercredi</b> : tu vas rendre l'inscription Ã  un Ã©vÃ©nement possible, de plus, nous allons te montrer comment brancher une API avec le systÃ¨me de paiement de Stripe</li>
  <li><b>Jeudi</b> : tu vas mettre un peu de front en voyant l'Asset Pipeline, puis nous allons te montrer comment faire des uploads de photo avec Active Storage</li>
  <li><b>Vendredi</b> : pour finir cette semaine en beautÃ©, tu mettras en place une interface administrateur oÃ¹ les administrateurs du site pourront faire des choses d'administrateur. HÃ©hÃ©.</li>
</ul>



<h3>2.2. Aujourd'hui : une base de donnÃ©es bien faite</h3>

<h4>2.2.1. La base de donnÃ©es</h4>
<p>Pour cette base de donnÃ©es, nous voyons trois models :</p>

<ul>
  <li>Un model <code>User</code>, qui rÃ©prÃ©sente les utilisateurs de notre site</li>
  <li>Un model <code>Event</code>, qui reprÃ©sente les Ã©vÃ©nements de notre site</li>
  <li>Un model <code>Attendance</code>, qui rÃ©prÃ©sente la participation Ã  un Ã©vÃ©nement. C'est la table de jointure entre les Ã©vÃ©nements et les participants Ã  un Ã©vÃ©nement (un peu comme les rendez-vous entre les docteurs et les patients)</li>
</ul>

<p>Pas besoin de plus.</p>

<h5>2.2.1.1. Les utilisateurs</h5>
<p>Un utilisateur aura comme attributs :</p>

<ul>
  <li>Un <code>email</code> (gÃ©rÃ© par la gem d'authentification que l'on verra demain)</li>
  <li>Un <code>encrypted_password</code> (gÃ©rÃ© par la gem d'authentification que l'on verra demain)</li>
  <li>Une <code>description</code>, qui est un <code>text</code></li>
  <li>Un <code>first_name</code>, qui est un <code>string</code></li>
  <li>Un <code>last_name</code>, qui est un <code>string</code></li>
</ul>

<p>Un utilisateur peut participer Ã  plusieurs Ã©vÃ©nements au travers des participations. Un utilisateur peut administrÃ© plusieurs Ã©vÃ©nements.</p>

<p>Ã‰tant donnÃ© que la gem d'authentification va gÃ©rer les validations importantes (email, mot de passe), pas besoin de validation pour les utilisateurs pour le moment.</p>


<h5>2.2.1.2. Les Ã©vÃ©nements</h5>
<p>Les Ã©vÃ©nements ont plusieurs attributs :</p>

<ul>
  <li>Une <code>start_date</code>, qui est un <code>datetime</code>. Sa prÃ©sence est obligatoire, et il est impossible de crÃ©er ou modifier un Ã©vÃ©nement dans le passÃ©.</li>
  <li>Une <code>duration</code>, qui est un <code>integer</code> reprÃ©sentant le nombre de minutes que cet Ã©vÃ©nement va durer. Sa prÃ©sence est obligatoire et le nombre de minutes doit Ãªtre un multiple de 5, et est strictement positif</li>
  <li>Un <code>title</code> qui est un <code>string</code>. Sa prÃ©sence est obligatoire et doit faire au moins 5 caractÃ¨res et maxi 140 caractÃ¨res</li>
  <li>Une <code>description</code> qui est un <code>text</code>. Sa prÃ©sence est obligatoire et la description doit faire entre 20 et 1000 caractÃ¨res</li>
  <li>Un <code>price</code> qui est un <code>integer</code>. Ce price correspond au nombre d'euros que coÃ»te l'Ã©vÃ©nement. Sa prÃ©sence est obligatoire et cet integer doit Ãªtre compris entre 1 et 1000. (pas d'Ã©vÃ©nement gratuit pour cette premiÃ¨re version de l'application)</li>
  <li>Une <code>location</code>, qui est un <code>string</code>. Sa prÃ©sence est obligatoire</li>
</ul>

<p>Un Ã©vÃ©nement a plusieurs participations, et plusieurs participants (utilisateurs) au travers des participations. Un Ã©vÃ©nement appartient Ã  un administrateur (utilisateur).</p>


<h5>2.2.1.3. Les participations</h5>
<p>Les participations ont un seul attribut :</p>

<ul>
  <li>Une <code>stripe_customer_id</code>, qui est un <code>string</code> et qui est l'identifiant unique donnÃ© par Stripe au payeur (pratique pour aller chercher ses informations)</li>
</ul>


<p>Une participation appartient Ã  un utilisateur, et un Ã©vÃ©nement.</p>


<h5>2.2.1.4. Construction de la base de donnÃ©es</h5>
<p>Maintenant que tu as toutes ces informations, construis la base de donnÃ©es. Tu dois faire :</p>

<ul>
  <li>Les trois models, avec leurs attributs</li>
  <li>Les validations</li>
  <li>Les tests unitaires de models</li>
  <li>Un seed</li>
</ul>

<p>âš  : info importante. MÃªme si je parle en franÃ§ais sur le site, il est communÃ©ment admis dans l'univers de la programmation de ne JAMAIS Ã©crire en franÃ§ais dans le code. Ainsi, quand je parle des utilisateurs, je parle de la classe <code>User</code>, quand je parle des Ã©vÃ©nements, je parle de la classe <code>Event</code>, quand je parle des participations, je parle de la classe <code>Attendance</code>. Il est donc <b>interdit</b> d'utiliser des classes, des attributs, ou des mÃ©thodes en franÃ§ais. Certains dÃ©veloppeurs vont mÃªme jusqu'Ã  interdire les commentaires en franÃ§ais, c'est dire si le franÃ§ais est banni dans les lignes de code.</p>


<h4>2.2.2. Le mailer</h4>
<p>Maintenant nous allons ajouter plusieurs mailers dans l'application. Ces emails doivent marcher en production, c'est Ã  dire qu'ils doivent bien envoyer l'email comme convenu.</p>

<h5>2.2.1. Un email Ã  la crÃ©ation d'utilisateur</h5>
<p>Quand un utilisateur est crÃ©Ã©, envoie-lui un email de bienvenue (indice : <code>after_create</code>)</p>

<h5>2.2.2. Un email quand quelqu'un participe Ã  l'Ã©vÃ©nement</h5>
<p>Quand un participant participe Ã  un Ã©vÃ©nement, envoie un email au crÃ©ateur de l'Ã©vÃ©nement (indice : <code>after_create</code>).</p>

<h2>3. Rendu attendu</h2>
<p>Une application avec le backend fonctionnel. Les models sont testÃ©s, et le mailer marche en production.</p>

          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>



</div>


  </div>
</div>
    <script src="/packs/dashboard-031178fac0de4f91cbcc.js"></script>
    

    <script charset="utf-8">
      $('input[name=authenticity_token]').val($('meta[name=csrf-token]').attr('content'));
    </script>

  </body>
</html>
